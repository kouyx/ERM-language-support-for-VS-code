{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "ERM",
  "scopeName": "source.erm",
  "fileTypes": ["erm"],
  "firstLineMatch": "^ZVSE",
  "patterns": [
    { "include": "#header" },
    { "include": "#receiver_bangbang" },
    { "include": "#instruction_banghash" },
    { "include": "#trigger_fun" },
    { "include": "#trigger_misc" },
    { "include": "#comment" },
    { "include": "#inline_comment" },
    { "include": "#erm_operator" },
    { "include": "#constants" },
    { "include": "#operators" },
    { "include": "#strings" }
  ],

  "repository": {
    "header": {
      "match": "^(ZVSE2?)",
      "name": "keyword.control.header.erm"
    },

    "comment": {
      "match": "^\\s*(?!!\\w|!\\?\\w|!#\\w).*$",
      "name": "comment.line.erm"
    },

    "receiver_bangbang": {
      "begin": "(\\s*)(!!)([A-Za-z]{2})",
      "beginCaptures": {
        "1": { "name": "punctuation.whitespace.erm" },
        "2": { "name": "keyword.operator.receiver.erm" },
        "3": { "name": "entity.name.function.receiver.erm" }
      },
      "end": "(?=;)",
      "name": "meta.receiver.erm",
      "patterns": [
        { "include": "#erm_operator" },
        { 
          "match": "\\b([A-Z]+)\\b", 
          "name": "keyword.control.command.erm" 
        },
        { "include": "#constants" },
        { "include": "#strings" },
        {
          "match": "&",
          "name": "keyword.operator.logical.erm"
        },
        {
          "match": "\\|",
          "name": "keyword.operator.logical.erm"
        }
      ]
    },

    "instruction_banghash": {
      "begin": "(\\s*)(!#)([A-Z]{2})",
      "beginCaptures": {
        "1": { "name": "punctuation.whitespace.erm" },
        "2": { "name": "keyword.operator.instruction.erm" },
        "3": { "name": "entity.name.function.instruction.erm" }
      },
      "end": "(?=;)",
      "name": "meta.instruction.erm",
      "patterns": [
        { "include": "#erm_operator" },
        { "include": "#constants" },
        { "include": "#strings" }
      ]
    },

    "trigger_fun": {
      "begin": "(\\s*)(!\\?FU)(?:(?:(\\d+)|(\\()([^)]+)(\\)))?)",
      "beginCaptures": {
        "1": { "name": "punctuation.whitespace.erm" },
        "2": { "name": "keyword.operator.trigger.erm" },
        "3": { "name": "constant.numeric.trigger-id.erm" },
        "4": { "name": "punctuation.parenthesis.open.erm" },
        "5": { "name": "entity.name.function.custom.erm" },
        "6": { "name": "punctuation.parenthesis.close.erm" }
      },
      "end": "(?=;)",
      "name": "meta.trigger.function.erm",
      "patterns": [
        { "include": "#erm_operator" },
        { "include": "#constants" },
        { "include": "#strings" }
      ]
    },

    "trigger_misc": {
      "match": "(\\s*)(![?$][A-Z]{2})",
      "captures": {
        "1": { "name": "punctuation.whitespace.erm" },
        "2": { "name": "keyword.operator.trigger.erm" }
      }
    },

    "inline_comment": {
      "begin": "(;)",
      "end": "(?=!!|!\\?|!#)|$",
      "beginCaptures": {
        "1": { "name": "punctuation.terminator.statement.erm" }
      },
      "contentName": "comment.inline.erm",
      "patterns": [
        {
          "match": "TODO|FIXME|NOTE|HACK|BUG|XXX",
          "name": "keyword.other.todo.erm"
        }
      ]
    },

    "string_caret": {
      "begin": "\\^",
      "end": "\\^",
      "name": "string.quoted.caret.erm",
      "patterns": [
        {
          "match": "%(?:%|\\\\:|\\\\\"|[a-zA-Z]?\\([^\\)\\r\\n]*\\)|[a-zA-Z][a-zA-Z0-9]*)",
          "name": "constant.character.escape.interpolation.erm"
        }
      ]
    },

    "strings": {
      "patterns": [
        { "include": "#string_caret" }
      ]
    },

    "constants": {
      "patterns": [
        {
          "match": "\\b(\\d+)\\b",
          "name": "constant.numeric.integer.erm"
        },
        {
          "match": "\\b(?:true|false)\\b",
          "name": "constant.language.boolean.erm"
        },
        {
          "match": "\\b(?:[A-Z_]+)\\b",
          "name": "constant.other.symbol.erm"
        }
      ]
    },

    "operators": {
      "patterns": [
        {
          "match": "=",
          "name": "keyword.operator.assignment.erm"
        },
        {
          "match": "[=!<>]=|[<>]",
          "name": "keyword.operator.comparison.erm"
        },
        {
          "match": "[+\\-*%]",
          "name": "keyword.operator.arithmetic.erm"
        },
        {
          "match": "[:;,]",
          "name": "punctuation.separator.erm"
        }
      ]
    },

    "erm_operator": {
      "patterns": [
        { "include": "#strings" },
        { 
          "match": "([g-t]|[xyvzwefc](?:-?\\d+)?)", 
          "name": "variable.parameter.register.erm" 
        },
        { "include": "#constants" },
        { 
          "match": "\\([^)]+\\)", 
          "name": "constant.other.named-constant.erm" 
        },
        { 
          "match": "\\[[^\\]]+\\]", 
          "name": "variable.other.label.erm" 
        },
        { 
          "match": "@[^@]*@?", 
          "name": "entity.name.tag.macro-declaration.erm" 
        },
        { 
          "match": "\\$[^$]*\\$?", 
          "name": "entity.name.tag.macro-usage.erm" 
        },
        { "include": "#operators" }
      ]
    }
  }
}