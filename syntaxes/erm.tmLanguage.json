{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "ERM",
  "scopeName": "source.erm",
  "fileTypes": ["erm"],
  "firstLineMatch": "^ZVSE",
  "patterns": [
    { "include": "#header" },
    { "include": "#flow_control" },
    { "include": "#receiver_bangbang" },
    { "include": "#instruction_banghash" },
    { "include": "#trigger_fun" },
    { "include": "#trigger_misc" },
    { "include": "#comment" },
    { "include": "#inline_comment" },
    { "include": "#erm_operator" },
    { "include": "#constants" },
    { "include": "#operators" },
    { "include": "#strings" }
  ],

  "repository": {
    "header": {
      "match": "^(ZVSE2?)",
      "name": "keyword.control.header.erm"
    },

    "flow_control": {
      "begin": "(\\s*)(!!)(if|el|else|re|br|en)\\b",
      "beginCaptures": {
        "1": { "name": "punctuation.whitespace.erm" },
        "2": { "name": "keyword.operator.receiver.erm" },
        "3": { "name": "keyword.control.flow.erm" }
      },
      "end": "(?=;)",
      "patterns": [
        { "include": "#erm_operator" }
      ]
    },

    "comment": {
      "match": "^\\s*(?!!\\w|!\\?\\w|!#\\w).*$",
      "name": "comment.line.erm"
    },

    "receiver_bangbang": {
      "begin": "(\\s*)(!!)([A-Za-z]{2})",
      "beginCaptures": {
        "1": { "name": "punctuation.whitespace.erm" },
        "2": { "name": "keyword.operator.receiver.erm" },
        "3": { "name": "entity.name.function.receiver.erm" }
      },
      "end": "(?=;)",
      "name": "meta.receiver.erm",
      "patterns": [
        { "include": "#erm_operator" },
        {
          "match": "\\b([A-Z]+)\\b",
          "name": "keyword.control.command.erm"
        },
        { "include": "#constants" },
        { "include": "#strings" },
        {
          "match": "[&|]",
          "name": "keyword.operator.logical.erm"
        }
      ]
    },

    "instruction_banghash": {
      "begin": "(\\s*)(!#)([A-Z]{2})",
      "beginCaptures": {
        "1": { "name": "punctuation.whitespace.erm" },
        "2": { "name": "keyword.operator.instruction.erm" },
        "3": { "name": "entity.name.function.instruction.erm" }
      },
      "end": "(?=;)",
      "name": "meta.instruction.erm",
      "patterns": [
        { "include": "#erm_operator" },
        { "include": "#constants" },
        { "include": "#strings" }
      ]
    },

    "trigger_fun": {
      "begin": "(\\s*)(!\\?FU)(?:(?:(\\d+)|(\\()([^)]+)(\\)))?)",
      "beginCaptures": {
        "1": { "name": "punctuation.whitespace.erm" },
        "2": { "name": "keyword.operator.trigger.erm" },
        "3": { "name": "constant.numeric.trigger-id.erm" },
        "4": { "name": "punctuation.section.parens.begin.erm" },
        "5": { "name": "entity.name.function.custom.erm" },
        "6": { "name": "punctuation.section.parens.end.erm" }
      },
      "end": "(?=;)",
      "name": "meta.trigger.function.erm",
      "patterns": [
        { "include": "#erm_operator" },
        { "include": "#constants" },
        { "include": "#strings" }
      ]
    },

    "trigger_misc": {
      "match": "(\\s*)(![?$][A-Z]{2})",
      "captures": {
        "1": { "name": "punctuation.whitespace.erm" },
        "2": { "name": "keyword.operator.trigger.erm" }
      }
    },
    
    "inline_comment": {
      "begin": "(;)",
      "end": "(?=!!|!\\?|!#)|$",
      "beginCaptures": {
        "1": { "name": "punctuation.terminator.statement.erm" }
      },
      "contentName": "comment.inline.erm",
      "patterns": [
        {
          "match": "TODO|FIXME|NOTE|HACK|BUG|XXX",
          "name": "keyword.other.todo.erm"
        }
      ]
    },

    "string_caret": {
      "begin": "\\^",
      "end": "\\^",
      "name": "string.quoted.caret.erm",
      "patterns": [
        {
          "comment": "插值变量：括号分离版",
          "match": "(%)([a-zA-Z]?)(\\()([^\\)\\r\\n]*)(\\))",
          "captures": {
            "1": { "name": "constant.character.escape.interpolation.erm" },
            "2": { "name": "variable.other.erm" },
            "3": { "name": "punctuation.section.parens.begin.erm" },
            "4": { "name": "variable.interpolation.erm" },
            "5": { "name": "punctuation.section.parens.end.erm" }
          }
        },
        {
          "comment": "普通转义或无括号变量",
          "match": "%(?:%|\\\\:|\\\\\"|[a-zA-Z][a-zA-Z0-9]*)",
          "name": "constant.character.escape.interpolation.erm"
        }
      ]
    },

    "strings": {
      "patterns": [
        { "include": "#string_caret" }
      ]
    },

    "constants": {
      "patterns": [
        {
          "match": "\\d+",
          "name": "constant.numeric.integer.erm"
        },
        {
          "match": "\\b(?:true|false)\\b",
          "name": "constant.language.boolean.erm"
        },
        {
          "match": "\\b(?:[A-Z_]+)\\b",
          "name": "constant.other.symbol.erm"
        }
      ]
    },

    "operators": {
      "patterns": [
        {
          "match": "=",
          "name": "keyword.operator.assignment.erm"
        },
        {
          "match": "(?:[=!<>]=|[<>])",
          "name": "keyword.operator.comparison.erm"
        },
        {
          "match": "[+\\-*%]",
          "name": "keyword.operator.arithmetic.erm"
        },
        {
          "match": "[:;,]",
          "name": "punctuation.separator.erm"
        }
      ]
    },

    "erm_operator": {
      "patterns": [
        { "include": "#strings" },
        {
          "match": "([evwxyz](?:-?\\d+)?)",
          "name": "variable.parameter.register.erm"
        },
        {
          "match": "([A-Z])",
          "name": "keyword.control.command.erm"
        },
        { "include": "#constants" },
        {
          "match": "(\\()([^)]+)(\\))",
          "captures": {
            "1": { "name": "punctuation.section.parens.begin.erm" },
            "2": { "name": "constant.other.named-constant.erm" },
            "3": { "name": "punctuation.section.parens.end.erm" }
          }
        },
        {
          "match": "\\[[^\\]]+\\]",
          "name": "variable.other.label.erm"
        },
        {
          "match": "@[^@]*@?",
          "name": "entity.name.tag.macro-declaration.erm"
        },
        {
          "match": "\\$[^$]*\\$?",
          "name": "entity.name.tag.macro-usage.erm"
        },
        { "include": "#operators" }
      ]
    }
  }
}